# DecisionModel 模块：设计与目的说明

本文档用于说明 DecisionModel 模块的设计动机、整体架构与在项目中的定位，便于汇报与讨论。

---

## 一、目的与动机

### 1.1 要解决的问题

在视觉问答（VQA）与数据筛选管线中，**筛选要素**通常以自然语言形式出现（如「图像中至少有一个视觉显著物体」「前景与背景可区分」等）。这些描述数量多、表述相近，若直接作为模型输出或路由依据，会导致：

- **维度高、稀疏**：每条样本对应一组文本，难以作为稳定的中间表示；
- **不可比**：不同样本的筛选要素集合难以统一映射到下游（如触发某类 VLM 校验或规则）；
- **可解释性弱**：若模型直接输出原始长句，不利于人工核查与管线配置。

因此需要：**将「自然语言筛选要素」抽象成有限、离散的「筛选原语」（factor_id），并学习「图像 → 筛选原语组合」的预测模型**，使该中间表示既能用于监督训练，又能作为**动态筛选管线与 VQA 构造的统一接口**。

### 1.2 模块定位

DecisionModel 在整体流程中的角色可概括为：

- **输入**：图像 + 与每张图像关联的**自然语言筛选要素集合**（来自上游标注或 ProbingFactorGeneration 等模块）；
- **输出**：  
  - 抽象后的**筛选原语表**（factor_id ↔ 原始文本映射，可解释）；  
  - **图像 → factor_id 多标签**的预测模型；  
  - 基于预测的 factor_id 组合进行**管线路由与验证**（如触发对应 VLM 校验或规则）。

即：**把「图像 + 自然语言筛选要素」转化为「图像 → 离散 factor_id 组合」的可学习、可解释中间表示，供后续筛选与 VQA 使用。**

### 1.3 预期产出

- 一套**最小可运行闭环**：从原始筛选要素文本到 factor 抽象、标签构造、因子预测、路由验证均可跑通；
- **两种因子预测方案**：轻量级（ResNet+MLP）与大规模视觉语言模型（Qwen2-VL），便于在资源与效果之间做权衡；
- **统一评估与对比**：同一数据与划分下，对两种模型做训练与测试，输出可对比的指标与报告。

---

## 二、整体设计

### 2.1 设计思路

整体采用「**先抽象、再监督、再预测、再路由**」的四段式设计：

1. **筛选要素抽象**：把自然语言筛选要素通过语义相似度聚类，归并为有限个「筛选原语」，并为每个原语分配唯一 factor_id，同时保留 factor_id → 原始文本列表的映射，保证可解释性。
2. **监督构造**：将每张图像关联的原始筛选要素文本集合，映射为 factor_id 集合，并编码为 multi-hot 向量，作为多标签监督信号。
3. **因子预测模型**：以图像为输入，预测各 factor_id 的取值（多标签），训练目标为 BCE 等多标签损失；骨干可采用轻量 CNN（ResNet）或 VLM（Qwen2-VL）。
4. **管线路由与验证**：根据预测的 factor_id 组合，调用或模拟对应的筛选原语执行逻辑（如 VLM 校验、规则检查），验证模型能否为不同图像生成合理、可解释的筛选要素组合，从而验证该中间表示可作为下游接口。

上述四段在代码中对应四个子模块，数据流与依赖关系清晰，便于扩展与替换（如更换骨干、增加新的路由逻辑）。

### 2.2 四段流程与子模块

| 阶段 | 子模块 | 功能简述 |
|------|--------|----------|
| 1. 筛选要素抽象 | `filter_factor_abstraction` | 对全部出现的筛选要素文本去重 → 冻结文本编码器（sentence-level 或 CLIP）编码 → 余弦相似度图 → 阈值/连通分量聚类 → 每个簇对应一个 factor_id，维护 factor_id → 原始文本列表。 |
| 2. 监督构造 | `label_construction` | 每张图的筛选要素文本集合 → 通过抽象阶段的 text→factor_id 映射 → 得到 factor_id 集合 → 编码为 multi-hot 向量（长度 = 原语个数）。 |
| 3. 因子预测 | `factor_prediction` | 图像 → 视觉编码器（ResNet 或 Qwen2-VL）→ 多标签头（线性/MLP）→ 各 factor 的 logits → BCE 训练；支持冻结骨干、仅训头。 |
| 4. 管线路由与验证 | `routing_sanity_check` | 根据预测的 factor_id 列表，解析为可执行的原语说明（Router、PrimitiveSpec），并可模拟执行；SanityCheck 统计可解释性、样例等，验证中间表示是否可用于下游。 |

### 2.3 关键设计选择

- **抽象阶段**：使用**冻结**文本编码器，不引入额外可训练参数，只做语义聚类与 id 分配；相似度采用余弦、聚类采用阈值图+连通分量，保证实现简单、可复现。
- **监督形式**：采用 **multi-hot 多标签**而非单标签或生成式文本，便于与现有分类/检测框架一致，且与路由阶段「离散 factor_id 组合」直接对应。
- **因子预测**：提供**两种骨干**——ResNet+MLP（轻量、CPU 可跑）与 Qwen2-VL（强视觉语义、需 GPU），数据格式与损失一致，便于在同一脚本下对比（`run_both_models.py`）。
- **可解释性**：全程保留 factor_id ↔ 原始文本的映射，路由与报告中均可回溯到自然语言描述，便于导师与下游协作方理解。

### 2.4 输入与输出

- **输入**：  
  - 标注数据：每行一条样本，包含 `image_path`、`filter_factor_texts`（该图对应的筛选要素自然语言列表），可选 `image_id`；  
  - 可选：筛选要素候选池 JSON（`filter_factors` 列表），用于无标注时生成合成数据。
- **输出**：  
  - 抽象结果：原语列表、text→factor_id、factor_id→texts；  
  - 训练好的因子预测模型（checkpoint）；  
  - 测试集上的多标签指标（BCE、SubsetAcc、F1 等）及可选的路由/SanityCheck 报告。

---

## 三、与项目其他部分的关系

- **ProbingFactorGeneration**：可提供或对齐「筛选要素」文本列表（如 `filter_factors_list.json`）；DecisionModel 的输入标注中的 `filter_factor_texts` 可与该类列表一致或为其子集。
- **FactorFilterAgent / VLM 校验与规则**：路由阶段产出的 factor_id 组合，可用于触发对应的 VLM 校验或 Rule_based 逻辑；当前实现为「模拟执行」，后续可替换为真实调用。
- **VQA 构造**：因子预测得到的「图像 → factor_id」可作为 VQA 题目筛选、难度或题型配置的输入，实现「图像 → 中间表示 → 下游决策」的闭环。

整体上，DecisionModel 充当「**图像 + 自然语言筛选要素 → 离散 factor 中间表示**」的桥梁，使后续筛选与 VQA 构造可以基于统一的、可学习的、可解释的 factor_id 组合进行操作。

---

## 四、两种因子预测方案

| 维度 | ResNet18 + MLP | Qwen2-VL（2B，冻结骨干） |
|------|----------------|---------------------------|
| 目的 | 轻量、快速验证与部署，CPU 可用 | 利用强视觉语义，追求更高预测质量 |
| 数据与监督 | 与 Qwen2-VL 相同（图像 + multi-hot） | 与 ResNet 相同 |
| 训练成本 | 低，显存/内存需求小 | 高，需 GPU，显存约 8–12 GB |
| 适用场景 | 原型、小规模数据、资源受限 | 数据与算力充足时的升级方案 |

两者在同一套数据与划分下可通过 `run_both_models.py` 做训练与测试对比，输出指标与报告便于向导师展示与讨论。

---

## 五、当前实现状态与可扩展点

- **已实现**：四段流程完整跑通；ResNet+MLP 与 Qwen2-VL 两种因子预测；抽象/标签构造/评估指标/统筹脚本；数据格式说明与示例。
- **可扩展**：  
  - 路由阶段对接真实 VLM 或 Rule_based 执行逻辑；  
  - 增加更多多标签评估指标（如 mAP）；  
  - 支持单独测试集文件、更大规模实验与消融（如不同抽象阈值、不同骨干）。

---

## 六、小结（可作汇报用）

DecisionModel 模块的**目的**是：在「图像 + 自然语言筛选要素」的基础上，通过**筛选要素抽象、监督构造、因子预测、管线路由验证**四段流程，得到**图像 → 离散 factor_id 多标签**的可学习、可解释中间表示，作为**动态筛选管线与 VQA 构造的统一接口**。

**设计**上采用先抽象后监督、多标签 BCE 训练、双骨干（ResNet / Qwen2-VL）可选、全程保留 factor_id↔文本映射以保证可解释性；**实现**上提供最小可运行闭环与两种模型的对比脚本，便于向导师展示设计合理性与实验结果。
